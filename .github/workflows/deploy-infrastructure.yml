name: Deploy Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'prod'
        type: choice
        options:
        - dev
        - staging
        - prod
      hosted_zone_id:
        description: 'Route 53 Hosted Zone ID for troop202.site'
        required: true
        type: string
  push:
    branches:
      - main
    paths:
      - 'cloudformation/**'
      - '.github/workflows/deploy-infrastructure.yml'

env:
  AWS_REGION: us-east-1
  DOMAIN_NAME: troop202.site

permissions:
  id-token: write   # Required for OIDC
  contents: read    # Required to checkout code

jobs:
  validate:
    name: Validate CloudFormation Templates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup AWS CLI
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-Validate
          aws-region: ${{ env.AWS_REGION }}
          role-duration-seconds: 3600

      - name: Validate SSL Certificate Template
        run: |
          aws cloudformation validate-template \
            --template-body file://cloudformation/ssl-certificate.yaml

      - name: Validate Shared KMS Key Template
        run: |
          aws cloudformation validate-template \
            --template-body file://cloudformation/shared-kms-key.yaml

      - name: Validate Foundation Template
        run: |
          aws cloudformation validate-template \
            --template-body file://cloudformation/foundation.yaml

      - name: Validate CloudFront Template
        run: |
          aws cloudformation validate-template \
            --template-body file://cloudformation/cloudfront.yaml

      - name: Validate Monitoring Template
        run: |
          aws cloudformation validate-template \
            --template-body file://cloudformation/monitoring.yaml

      - name: Install cfn-lint
        run: |
          pip install cfn-lint

      - name: Lint CloudFormation Templates
        run: |
          cfn-lint cloudformation/*.yaml || true  # Allow to continue even with warnings

  deploy-certificate:
    name: Deploy SSL Certificate
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    environment: ${{ github.event.inputs.environment || 'prod' }}
    outputs:
      certificate-deployed: ${{ steps.deploy-cert.outputs.stack-status }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup AWS CLI
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-Certificate
          aws-region: ${{ env.AWS_REGION }}
          role-duration-seconds: 3600

      - name: Set environment variables
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "ENVIRONMENT=${{ github.event.inputs.environment }}" >> $GITHUB_ENV
            echo "HOSTED_ZONE_ID=${{ github.event.inputs.hosted_zone_id }}" >> $GITHUB_ENV
          else
            echo "ENVIRONMENT=prod" >> $GITHUB_ENV
            echo "HOSTED_ZONE_ID=${{ secrets.HOSTED_ZONE_ID }}" >> $GITHUB_ENV
          fi

      - name: Deploy SSL Certificate Stack
        id: deploy-cert
        run: |
          STACK_NAME="troop202-ssl-cert-${ENVIRONMENT}"
          
          echo "Deploying SSL certificate stack: $STACK_NAME"
          
          aws cloudformation deploy \
            --template-file cloudformation/ssl-certificate.yaml \
            --stack-name "$STACK_NAME" \
            --region ${{ env.AWS_REGION }} \
            --parameter-overrides \
              DomainName=${{ env.DOMAIN_NAME }} \
              HostedZoneId="$HOSTED_ZONE_ID" \
              Environment="$ENVIRONMENT" \
            --tags \
              Environment="$ENVIRONMENT" \
              Project="Troop202Website" \
              ManagedBy="GitHubActions" \
              Repository="${{ github.repository }}" \
              CommitSha="${{ github.sha }}" \
            --no-fail-on-empty-changeset

          echo "stack-status=success" >> $GITHUB_OUTPUT

      - name: Wait for Certificate Validation
        run: |
          echo "Waiting for SSL certificate validation..."
          
          CERT_ARN=$(aws ssm get-parameter \
            --name "/troop202/${ENVIRONMENT}/ssl-certificate-arn" \
            --region ${{ env.AWS_REGION }} \
            --query 'Parameter.Value' \
            --output text)
          
          echo "Certificate ARN: $CERT_ARN"
          
          # Wait for certificate to be issued (maximum 30 minutes)
          MAX_ATTEMPTS=60
          ATTEMPT=1
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            STATUS=$(aws acm describe-certificate \
              --certificate-arn "$CERT_ARN" \
              --region ${{ env.AWS_REGION }} \
              --query 'Certificate.Status' \
              --output text)
            
            if [ "$STATUS" = "ISSUED" ]; then
              echo "‚úÖ Certificate validation completed"
              break
            elif [ "$STATUS" = "FAILED" ]; then
              echo "‚ùå Certificate validation failed"
              exit 1
            fi
            
            echo "Certificate status: $STATUS (attempt $ATTEMPT/$MAX_ATTEMPTS)"
            sleep 30
            ((ATTEMPT++))
          done
          
          if [ $ATTEMPT -gt $MAX_ATTEMPTS ]; then
            echo "‚ùå Certificate validation timed out after 30 minutes"
            exit 1
          fi

  deploy-shared-kms:
    name: Deploy Shared KMS Key (once and done!)
    runs-on: ubuntu-latest
    needs: [validate, deploy-certificate]
    if: needs.deploy-certificate.outputs.certificate-deployed == 'success'
    environment: ${{ github.event.inputs.environment || 'prod' }}
    outputs:
      kms-deployed: ${{ steps.deploy-kms.outputs.stack-status }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup AWS CLI
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-SharedKMS
          aws-region: ${{ env.AWS_REGION }}
          role-duration-seconds: 3600

      - name: Set environment variables
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "ENVIRONMENT=${{ github.event.inputs.environment }}" >> $GITHUB_ENV
          else
            echo "ENVIRONMENT=prod" >> $GITHUB_ENV
          fi

      - name: Deploy Shared KMS Key Stack
        id: deploy-kms
        run: |
          STACK_NAME="troop202-shared-kms"
          
          echo "üîê Deploying shared KMS key: $STACK_NAME (no more KMS headaches!)"
          
          aws cloudformation deploy \
            --template-file cloudformation/shared-kms-key.yaml \
            --stack-name "$STACK_NAME" \
            --region ${{ env.AWS_REGION }} \
            --parameter-overrides \
              Environment="$ENVIRONMENT" \
            --capabilities CAPABILITY_IAM \
            --tags \
              Environment="$ENVIRONMENT" \
              Project="Troop202Website" \
              ManagedBy="GitHubActions" \
              Repository="${{ github.repository }}" \
              CommitSha="${{ github.sha }}" \
            --no-fail-on-empty-changeset

          echo "stack-status=success" >> $GITHUB_OUTPUT
          echo "‚úÖ Shared KMS key deployed - all other stacks will use this!"

  deploy-foundation:
    name: Deploy Foundation Stack (S3, WAF)
    runs-on: ubuntu-latest
    needs: [validate, deploy-certificate, deploy-shared-kms]
    if: needs.deploy-shared-kms.outputs.kms-deployed == 'success'
    environment: ${{ github.event.inputs.environment || 'prod' }}
    outputs:
      foundation-deployed: ${{ steps.deploy-foundation.outputs.stack-status }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup AWS CLI
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-Foundation
          aws-region: ${{ env.AWS_REGION }}
          role-duration-seconds: 3600

      - name: Set environment variables
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "ENVIRONMENT=${{ github.event.inputs.environment }}" >> $GITHUB_ENV
          else
            echo "ENVIRONMENT=prod" >> $GITHUB_ENV
          fi

      # NOTE: Foundation stack now exports the shared KMS key ARN to keep 
      # monitoring stack happy during transition. Next PR will clean this up.
      - name: Deploy Foundation Stack
        id: deploy-foundation
        run: |
          STACK_NAME="${ENVIRONMENT}-troop202-foundation"
          
          echo "üèóÔ∏è Deploying foundation stack: $STACK_NAME"
          
          aws cloudformation deploy \
            --template-file cloudformation/foundation.yaml \
            --stack-name "$STACK_NAME" \
            --region ${{ env.AWS_REGION }} \
            --parameter-overrides \
              Environment="$ENVIRONMENT" \
            --capabilities CAPABILITY_IAM \
            --tags \
              Environment="$ENVIRONMENT" \
              Project="Troop202Website" \
              ManagedBy="GitHubActions" \
              Repository="${{ github.repository }}" \
              CommitSha="${{ github.sha }}" \
            --no-fail-on-empty-changeset

          echo "stack-status=success" >> $GITHUB_OUTPUT
          echo "‚úÖ Foundation stack deployed successfully"

  deploy-cloudfront:
    name: Deploy CloudFront Stack (15-20 min)
    runs-on: ubuntu-latest
    needs: [validate, deploy-certificate, deploy-foundation]
    if: needs.deploy-foundation.outputs.foundation-deployed == 'success'
    environment: ${{ github.event.inputs.environment || 'prod' }}
    outputs:
      cloudfront-deployed: ${{ steps.deploy-cloudfront.outputs.stack-status }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup AWS CLI
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-CloudFront
          aws-region: ${{ env.AWS_REGION }}
          role-duration-seconds: 3600

      - name: Set environment variables
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "ENVIRONMENT=${{ github.event.inputs.environment }}" >> $GITHUB_ENV
            echo "HOSTED_ZONE_ID=${{ github.event.inputs.hosted_zone_id }}" >> $GITHUB_ENV
          else
            echo "ENVIRONMENT=prod" >> $GITHUB_ENV
            echo "HOSTED_ZONE_ID=${{ secrets.HOSTED_ZONE_ID }}" >> $GITHUB_ENV
          fi

      - name: Deploy CloudFront Stack
        id: deploy-cloudfront
        run: |
          STACK_NAME="${ENVIRONMENT}-troop202-cloudfront"
          FOUNDATION_STACK="${ENVIRONMENT}-troop202-foundation"
          
          echo "‚òÅÔ∏è Deploying CloudFront stack: $STACK_NAME (this takes 15-20 minutes)"
          
          aws cloudformation deploy \
            --template-file cloudformation/cloudfront.yaml \
            --stack-name "$STACK_NAME" \
            --region ${{ env.AWS_REGION }} \
            --parameter-overrides \
              Environment="$ENVIRONMENT" \
              DomainName=${{ env.DOMAIN_NAME }} \
              PriceClass="PriceClass_100" \
              FoundationStackName="$FOUNDATION_STACK" \
              HostedZoneId="$HOSTED_ZONE_ID" \
            --capabilities CAPABILITY_IAM \
            --tags \
              Environment="$ENVIRONMENT" \
              Project="Troop202Website" \
              ManagedBy="GitHubActions" \
              Repository="${{ github.repository }}" \
              CommitSha="${{ github.sha }}" \
            --no-fail-on-empty-changeset

          echo "stack-status=success" >> $GITHUB_OUTPUT
          echo "‚úÖ CloudFront stack deployed successfully"

  deploy-monitoring:
    name: Deploy Monitoring Stack (2-3 min)
    runs-on: ubuntu-latest
    needs: [validate, deploy-certificate, deploy-foundation, deploy-cloudfront]
    if: needs.deploy-cloudfront.outputs.cloudfront-deployed == 'success'
    environment: ${{ github.event.inputs.environment || 'prod' }}
    outputs:
      monitoring-deployed: ${{ steps.deploy-monitoring.outputs.stack-status }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup AWS CLI
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-Monitoring
          aws-region: ${{ env.AWS_REGION }}
          role-duration-seconds: 3600

      - name: Set environment variables
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "ENVIRONMENT=${{ github.event.inputs.environment }}" >> $GITHUB_ENV
          else
            echo "ENVIRONMENT=prod" >> $GITHUB_ENV
          fi

      - name: Deploy Monitoring Stack
        id: deploy-monitoring
        run: |
          STACK_NAME="${ENVIRONMENT}-troop202-monitoring"
          FOUNDATION_STACK="${ENVIRONMENT}-troop202-foundation"
          CLOUDFRONT_STACK="${ENVIRONMENT}-troop202-cloudfront"
          
          echo "üìä Deploying monitoring stack: $STACK_NAME"
          
          aws cloudformation deploy \
            --template-file cloudformation/monitoring.yaml \
            --stack-name "$STACK_NAME" \
            --region ${{ env.AWS_REGION }} \
            --parameter-overrides \
              Environment="$ENVIRONMENT" \
              FoundationStackName="$FOUNDATION_STACK" \
              CloudFrontStackName="$CLOUDFRONT_STACK" \
            --capabilities CAPABILITY_IAM \
            --tags \
              Environment="$ENVIRONMENT" \
              Project="Troop202Website" \
              ManagedBy="GitHubActions" \
              Repository="${{ github.repository }}" \
              CommitSha="${{ github.sha }}" \
            --no-fail-on-empty-changeset

          echo "stack-status=success" >> $GITHUB_OUTPUT
          echo "‚úÖ Monitoring stack deployed successfully"

  deploy-website:
    name: Get Deployment Summary
    runs-on: ubuntu-latest
    needs: [validate, deploy-certificate, deploy-foundation, deploy-cloudfront, deploy-monitoring]
    if: needs.deploy-monitoring.outputs.monitoring-deployed == 'success'
    environment: ${{ github.event.inputs.environment || 'prod' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup AWS CLI
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-Website
          aws-region: ${{ env.AWS_REGION }}
          role-duration-seconds: 3600

      - name: Set environment variables
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "ENVIRONMENT=${{ github.event.inputs.environment }}" >> $GITHUB_ENV
          else
            echo "ENVIRONMENT=prod" >> $GITHUB_ENV
          fi

      - name: Get Stack Outputs and Generate Summary
        run: |
          CERT_STACK_NAME="troop202-ssl-cert-${ENVIRONMENT}"
          FOUNDATION_STACK_NAME="${ENVIRONMENT}-troop202-foundation"
          CLOUDFRONT_STACK_NAME="${ENVIRONMENT}-troop202-cloudfront"
          MONITORING_STACK_NAME="${ENVIRONMENT}-troop202-monitoring"
          
          echo "## üöÄ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Environment: \`${ENVIRONMENT}\`" >> $GITHUB_STEP_SUMMARY
          echo "### Domain: \`${{ env.DOMAIN_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get certificate ARN
          CERT_ARN=$(aws cloudformation describe-stacks \
            --stack-name "$CERT_STACK_NAME" \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`CertificateArn`].OutputValue' \
            --output text)
          
          echo "### SSL Certificate" >> $GITHUB_STEP_SUMMARY
          echo "- **ARN**: \`${CERT_ARN}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get foundation outputs
          BUCKET_NAME=$(aws cloudformation describe-stacks \
            --stack-name "$FOUNDATION_STACK_NAME" \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`WebsiteBucketName`].OutputValue' \
            --output text)
          
          echo "### üèóÔ∏è Foundation Stack" >> $GITHUB_STEP_SUMMARY
          echo "- **S3 Bucket**: \`${BUCKET_NAME}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ‚úÖ S3, KMS, WAF deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get CloudFront outputs
          DISTRIBUTION_ID=$(aws cloudformation describe-stacks \
            --stack-name "$CLOUDFRONT_STACK_NAME" \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`CloudFrontDistributionId`].OutputValue' \
            --output text)
          
          DISTRIBUTION_DOMAIN=$(aws cloudformation describe-stacks \
            --stack-name "$CLOUDFRONT_STACK_NAME" \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`CloudFrontDistributionDomainName`].OutputValue' \
            --output text)
          
          echo "### ‚òÅÔ∏è CloudFront Stack" >> $GITHUB_STEP_SUMMARY
          echo "- **Distribution ID**: \`${DISTRIBUTION_ID}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **CloudFront Domain**: \`${DISTRIBUTION_DOMAIN}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ‚úÖ Distribution and security headers deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### üìä Monitoring Stack" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ‚úÖ CloudWatch logs and dashboard deployed" >> $GITHUB_STEP_SUMMARY
          echo "- **Dashboard**: [View Dashboard](https://console.aws.amazon.com/cloudwatch/home?region=${{ env.AWS_REGION }}#dashboards:name=${ENVIRONMENT}-Troop202-Website)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### üåê Website URLs" >> $GITHUB_STEP_SUMMARY
          echo "- **Primary**: https://${{ env.DOMAIN_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **CloudFront**: https://${DISTRIBUTION_DOMAIN}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### üìã Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. ‚úÖ All infrastructure deployed successfully" >> $GITHUB_STEP_SUMMARY
          echo "2. üöÄ Content deployment will start automatically" >> $GITHUB_STEP_SUMMARY
          echo "3. üìù Update DNS records to point to CloudFront distribution" >> $GITHUB_STEP_SUMMARY
          echo "4. ‚ú® Website will be live at https://${{ env.DOMAIN_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üí° Development Tips" >> $GITHUB_STEP_SUMMARY
          echo "- **Foundation changes** (S3, WAF): ~5-10 min redeploy" >> $GITHUB_STEP_SUMMARY
          echo "- **Monitoring changes**: ~2-3 min redeploy" >> $GITHUB_STEP_SUMMARY
          echo "- **CloudFront changes**: ~15-20 min redeploy (avoid if possible)" >> $GITHUB_STEP_SUMMARY

  cleanup-on-failure:
    name: Cleanup on Failure
    runs-on: ubuntu-latest
    needs: [deploy-certificate, deploy-foundation, deploy-cloudfront, deploy-monitoring]
    if: failure() && github.event_name == 'workflow_dispatch'
    environment: ${{ github.event.inputs.environment || 'prod' }}
    steps:
      - name: Setup AWS CLI
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-Cleanup
          aws-region: ${{ env.AWS_REGION }}
          role-duration-seconds: 3600

      - name: Set environment variables
        run: |
          echo "ENVIRONMENT=${{ github.event.inputs.environment }}" >> $GITHUB_ENV

      - name: Cleanup Failed Stacks
        continue-on-error: true
        run: |
          echo "üßπ Cleaning up failed deployments..."
          
          # Delete stacks in reverse order
          STACKS_TO_DELETE=(
            "${ENVIRONMENT}-troop202-monitoring"
            "${ENVIRONMENT}-troop202-cloudfront" 
            "${ENVIRONMENT}-troop202-foundation"
          )
          
          for STACK_NAME in "${STACKS_TO_DELETE[@]}"; do
            if aws cloudformation describe-stacks --stack-name "$STACK_NAME" --region ${{ env.AWS_REGION }} >/dev/null 2>&1; then
              echo "Deleting stack: $STACK_NAME"
              aws cloudformation delete-stack --stack-name "$STACK_NAME" --region ${{ env.AWS_REGION }}
              echo "Waiting for stack deletion to complete..."
              aws cloudformation wait stack-delete-complete --stack-name "$STACK_NAME" --region ${{ env.AWS_REGION }}
              echo "‚úÖ Stack $STACK_NAME deleted"
            else
              echo "Stack $STACK_NAME not found, skipping"
            fi
          done
          
          # Note: We don't delete the certificate stack automatically as it might be used by other resources
          echo "‚ö†Ô∏è Certificate stack was not deleted. Please review and clean up manually if needed."